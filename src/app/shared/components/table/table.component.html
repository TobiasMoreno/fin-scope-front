<div class="relative rounded-lg shadow-md overflow-hidden table border border-[var(--border)]" style="background: var(--card);">
  @if (loading()) {
  <div class="absolute inset-0 flex items-center justify-center z-10">
    <mat-spinner></mat-spinner>
  </div>
  } @if (config()?.showColumnSelector || shouldShowAddButton()) {
  <div class=" flex flex-row justify-between items-center w-full p-4 border-b border-[var(--border)]">
    <h1 class="text-xl" >{{ config()?.title }}</h1>
    <div class="flex items-center gap-2">
      @if (shouldShowAddButton()) {
      <app-button
        color="green"
        variant="secondary"
        size="medium"
        (click)="onAddClick()"
        class="flex items-center gap-2 w-full"
      >
        <mat-icon>add</mat-icon>
        {{ getAddButtonText() }}
      </app-button>
      }
      @if (config()?.showColumnSelector) {
      <button
        mat-icon-button
        [matMenuTriggerFor]="columnMenu"
        aria-label="Columnas"
      >
        <mat-icon>view_column</mat-icon>
      </button>
      <mat-menu #columnMenu="matMenu">
        @for (column of config()?.columns; track column.name) {
        <button mat-menu-item (click)="toggleColumn(column)">
          <mat-checkbox
            [checked]="isColumnVisible(column.name)"
            (click)="$event.stopPropagation()"
            (change)="toggleColumn(column)"
          >
            {{ column.header }}
          </mat-checkbox>
        </button>
        }
      </mat-menu>
      }
    </div>
  </div>
  }

  <div class="overflow-x-auto" >
    @defer (when !loading()) {
      <mat-table
        mat-table
        [dataSource]="tableDataSource"
        matSort
        (matSortChange)="onSortChange($event)"
        class="w-full bg-[var(--card)]"
      >
        @for (column of config()?.columns; track column.name) { @if
        (isColumnVisible(column.name)) {
        <ng-container [matColumnDef]="column.name">
          <th
            mat-header-cell
            *matHeaderCellDef
            [mat-sort-header]="column.sortable ? column.name : ''"
            [disabled]="!column.sortable"
            class="px-4 py-3 border-b font-medium"
            style="color: var(--card-foreground); background: var(--card); border-color: var(--border);"
          >
            {{ column.header }}
          </th>
          <td
            mat-cell
            *matCellDef="let row"
            (click)="onRowClick(row)"
            [attr.data-sort]="row[column.name]"
            class="px-4 py-3 border-b transition-colors cursor-pointer"
            style="color: var(--card-foreground); background: var(--card); border-color: var(--border);"
          >
            @switch (getColumnType(column)) { @case ('date') {
            {{ row[column.name] | date : "dd/MM/yyyy" }}
            } @case ('currency') {
            {{ row[column.name] | currency : "EUR" : "symbol" : "1.2-2" }}
            } @case ('boolean') {
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
              [class]="
                row[column.name]
                  ? 'bg-green-600 text-green-100'
                  : 'bg-red-600 text-red-100'
              "
            >
              {{ row[column.name] ? "Activo" : "Inactivo" }}
            </span>
            } @default {
            <span [class]="shouldShowColorIndicator(column) ? getValueColorClass(row[column.name]) : ''">
              {{ row[column.name] }}
            </span>
            } }
          </td>
        </ng-container>
        } }

        <!-- Columna de acciones -->
        @if (config()?.showActions) {
        <ng-container [matColumnDef]="actionsColumn">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="px-4 py-3 border-b font-medium text-center"
            style="color: var(--card-foreground); background: var(--card); border-color: var(--border);"
          >
            Acciones
          </th>
          <td
            mat-cell
            *matCellDef="let row"
            class="px-4 py-3 border-b text-center"
          >
            <div class="action-buttons-container">
              @if (shouldShowViewButton()) {
              <button
                mat-icon-button
                color="primary"
                [matTooltip]="getViewButtonText()"
                (click)="onViewClick(row, $event)"
                class="action-button"
              >
                <mat-icon>visibility</mat-icon>
              </button>
              }
              @if (shouldShowEditButton()) {
              <button
                mat-icon-button
                [matTooltip]="getEditButtonText()"
                (click)="onEditClick(row, $event)"
                class="action-button"
              >
                <mat-icon>edit</mat-icon>
              </button>
              }
              @if (shouldShowDeleteButton()) {
              <button
                mat-icon-button
                color="warn"
                [matTooltip]="getDeleteButtonText()"
                (click)="onDeleteClick(row, $event)"
                class="action-button"
              >
                <mat-icon>delete</mat-icon>
              </button>
              }
              @if (getCustomActions().length > 0) {
              <button
                mat-icon-button
                [matMenuTriggerFor]="customActionsMenu"
                [matTooltip]="'MÃ¡s acciones'"
                class="action-button"
              >
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #customActionsMenu="matMenu">
                @for (action of getCustomActions(); track action.name) {
                @if (action.visible !== false) {
                <button
                  mat-menu-item
                  [disabled]="action.disabled"
                  (click)="onCustomActionClick(action.name, row, $event)"
                >
                  <mat-icon [color]="action.color">{{ action.icon }}</mat-icon>
                  <span>{{ action.tooltip }}</span>
                </button>
                }
                }
              </mat-menu>
              }
            </div>
          </td>
        </ng-container>
        }

        <tr mat-header-row *matHeaderRowDef="visibleColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: visibleColumns"
          class="transition-colors"
          [class]="'hover:bg-[var(--accent)]'"
        ></tr>
      </mat-table>
    } @placeholder {
      <!-- Skeleton loading para la tabla -->
      <div class="p-4 space-y-3">
        @for (item of [1,2,3,4,5]; track item) {
          <div class="flex items-center space-x-4">
            @for (column of config()?.columns; track column.name) {
              @if (isColumnVisible(column.name)) {
                <app-skeleton [config]="{ type: 'text', width: '120px' }"></app-skeleton>
              }
            }
          </div>
        }
      </div>
    } @loading {
      <!-- Loading state adicional si es necesario -->
      <div class="flex justify-center items-center p-8">
        <mat-spinner></mat-spinner>
      </div>
    }
  </div>

  @if (config()?.showPaginator) {
  <div class="border-t" style="border-color: var(--border);">
    <mat-paginator
      [length]="config()?.totalItems || dataSource().length"
      [pageSize]="config()?.pageSize || 10"
      [pageSizeOptions]="config()?.pageSizeOptions || [5, 10, 25]"
      (page)="onPageChange($event)"
    ></mat-paginator>
  </div>
  }
</div>
